<!-- INTERFACE 1: Actions List Page -->
@if (viewMode() === 'list') {
  <div class="container-fluid py-4">
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="mb-3">Mes Actions</h2>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label class="form-label small fw-bold">Filtrer par Etat</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="filter" id="filter-all"
                     [checked]="filterState() === 'all'" (change)="filterState.set('all')">
              <label class="btn btn-outline-secondary btn-sm" for="filter-all">Tous</label>

              <input type="radio" class="btn-check" name="filter" id="filter-p"
                     [checked]="filterState() === 'P'" (change)="filterState.set('P')">
              <label class="btn btn-outline-secondary btn-sm" for="filter-p">P</label>

              <input type="radio" class="btn-check" name="filter" id="filter-d"
                     [checked]="filterState() === 'D'" (change)="filterState.set('D')">
              <label class="btn btn-outline-secondary btn-sm" for="filter-d">D</label>

              <input type="radio" class="btn-check" name="filter" id="filter-c"
                     [checked]="filterState() === 'C'" (change)="filterState.set('C')">
              <label class="btn btn-outline-secondary btn-sm" for="filter-c">C</label>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label small fw-bold">Trier par</label>
            <select class="form-select form-select-sm" [(ngModel)]="sortBy">
              <option value="deadline">Deadline</option>
              <option value="state">Etat</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Titre</th>
                <th>Plan d'Action</th>
                <th>Etat</th>
                <th>Deadline</th>
                <th>Responsable</th>
                <th>Pilote</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (action of filteredActions(); track action.id) {
                <tr class="cursor-pointer" (click)="selectAction(action)">
                  <td><strong>{{ action.title }}</strong></td>
                  <td>{{ action.planName }}</td>
                  <td>
                    <span class="badge" [ngClass]="'bg-' + getStateColor(action.state)">
                      {{ action.state }}
                    </span>
                  </td>
                  <td>
                    <span [ngClass]="getDeadlineColor(action.deadline)">
                      {{ action.deadline | date: 'dd/MM/yyyy' }}
                    </span>
                  </td>
                  <td>{{ action.responsable }}</td>
                  <td>{{ action.pilote }}</td>
                  <td><i class="feather icon-chevron-right"></i></td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
}
<!-- INTERFACE 2: Action Detail Page -->
@if (viewMode() === 'detail' && selectedAction()) {
  <div class="container-fluid py-4">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-outline-secondary btn-sm me-3" (click)="goBackToList()">
              <i class="feather icon-arrow-left"></i> Retour
            </button>
            <span class="h5 d-inline">{{ selectedAction()!.title }}</span>
          </div>
          <div>
            <button class="btn btn-outline-warning btn-sm me-2">
              <i class="feather icon-refresh-cw"></i> Reinitialiser validation
            </button>
            <button class="btn btn-outline-danger btn-sm">
              <i class="feather icon-trash-2"></i> Reinitialiser tous
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <label class="form-label small fw-bold">Theme</label>
            <p class="mb-3">{{ selectedAction()!.theme }}</p>
            <label class="form-label small fw-bold">PREV/CORR</label>
            <p class="mb-3">{{ selectedAction()!.prevCorr }}</p>
            <label class="form-label small fw-bold">Anomalie/Amelio</label>
            <p>{{ selectedAction()!.anomAmel }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <label class="form-label small fw-bold">Date creation</label>
            <p class="mb-3">{{ selectedAction()!.dateCreation | date: 'dd/MM/yyyy' }}</p>
            <label class="form-label small fw-bold">Criticite</label>
            <p class="mb-3">{{ selectedAction()!.criticite }}</p>
            <label class="form-label small fw-bold">Efficacite</label>
            <p>{{ selectedAction()!.efficacite }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <label class="form-label small fw-bold">Responsable</label>
            <p class="mb-3">{{ selectedAction()!.responsable }}</p>
            <label class="form-label small fw-bold">Plan d'Action</label>
            <p class="mb-3">{{ selectedAction()!.planName }}</p>
            <label class="form-label small fw-bold">Cause</label>
            <p>{{ selectedAction()!.cause }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <label class="form-label small fw-bold">Delai</label>
            <p class="mb-3">
              <span class="badge" [ngClass]="'bg-' + getStateColor(selectedAction()!.state)">
                {{ selectedAction()!.deadline | date: 'dd/MM/yyyy' }}
              </span>
            </p>
            <label class="form-label small fw-bold">Pilote</label>
            <p class="mb-3">{{ selectedAction()!.pilote }}</p>
            <label class="form-label small fw-bold">Etat</label>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn"
                      [ngClass]="selectedAction()!.state === 'P' ? 'btn-secondary' : 'btn-outline-secondary'"
                      disabled>P</button>
              <button type="button" class="btn"
                      [ngClass]="selectedAction()!.state === 'D' ? 'btn-warning' : 'btn-outline-secondary'"
                      disabled>D</button>
              <button type="button" class="btn"
                      [ngClass]="selectedAction()!.state === 'C' ? 'btn-success' : 'btn-outline-secondary'"
                      disabled>C</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <label class="form-label small fw-bold">Description</label>
            <p>{{ selectedAction()!.description }}</p>
            <label class="form-label small fw-bold">Commentaire</label>
            <p>{{ selectedAction()!.commentaire }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0">Realisation de l'Action</h6>
          </div>
          <div class="card-body">
            @if (selectedAction()!.state === 'P') {
              <p class="text-muted mb-3">Cette action n'est pas encore realisee</p>
              <button class="btn btn-primary" (click)="openClosureForm()">
                <i class="feather icon-check"></i> Cloturer l'action
              </button>

              @if (showClosureForm()) {
                <div class="mt-4 p-3 border rounded bg-light">
                  <h6 class="mb-3">Formulaire de Cloture</h6>
                  <div class="mb-3">
                    <label class="form-label small fw-bold">Commentaire de cloture</label>
                    <textarea class="form-control" rows="3" [(ngModel)]="closureComment"
                              placeholder="Decrivez les resultats..."></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold">Methode de verification</label>
                    <textarea class="form-control" rows="2" [(ngModel)]="verificationMethod"
                              placeholder="Comment sera verifiee?"></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold">Date de verification</label>
                    <input type="date" class="form-control" [(ngModel)]="verificationDate">
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" (click)="saveClosure()">
                      <i class="feather icon-save"></i> Enregistrer
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" (click)="resetClosureForm()">
                      Annuler
                    </button>
                  </div>
                </div>
              }
            } @else if (selectedAction()!.state === 'D' || selectedAction()!.state === 'C') {
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Date de realisation</label>
                  <p>{{ selectedAction()!.dateRealisee | date: 'dd/MM/yyyy' }}</p>
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Commentaire de cloture</label>
                  <p>{{ selectedAction()!.commentaireClosture }}</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Methode de verification</label>
                  <p>{{ selectedAction()!.methodVerification }}</p>
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Date de verification</label>
                  <p>{{ selectedAction()!.dateVerification | date: 'dd/MM/yyyy' }}</p>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-light">
            <h6 class="mb-0">Fichier Annexe a cette Action</h6>
          </div>
          <div class="card-body">
            @if (selectedAction()!.files && selectedAction()!.files!.length > 0) {
              <ul class="list-group mb-3">
                @for (file of selectedAction()!.files; track file.id) {
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ file.name }}</strong>
                      <small class="d-block text-muted">{{ file.description }}</small>
                    </div>
                    <a href="#" class="btn btn-sm btn-outline-primary">
                      <i class="feather icon-download"></i>
                    </a>
                  </li>
                }
              </ul>
            } @else {
              <p class="text-muted">Aucun fichier annexe</p>
            }

            <div class="border-top pt-3">
              <h6 class="mb-3 small">Ajouter un fichier annexe</h6>
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm"
                       [(ngModel)]="fileDescription" placeholder="Description">
              </div>
              <div class="mb-2">
                <input type="file" class="form-control form-control-sm">
              </div>
              <button class="btn btn-sm btn-primary">
                <i class="feather icon-upload"></i> Telecharger
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-light">
            <h6 class="mb-0">Historique des commentaires</h6>
          </div>
          <div class="card-body d-flex flex-column" style="height: 400px;">
            <div class="comments-list flex-grow-1 overflow-y-auto mb-3">
              @if (selectedAction()!.comments && selectedAction()!.comments!.length > 0) {
                @for (comment of selectedAction()!.comments; track comment.id) {
                  <div class="comment-item mb-3 pb-3 border-bottom">
                    <strong>{{ comment.author }}</strong>
                    <small class="text-muted d-block">{{ comment.timestamp }}</small>
                    <p class="mb-0 mt-1 small">{{ comment.text }}</p>
                  </div>
                }
              } @else {
                <p class="text-muted">Aucun commentaire</p>
              }
            </div>

            <div class="border-top pt-3">
              <h6 class="mb-2 small">Ajouter un Commentaire</h6>
              <textarea class="form-control form-control-sm mb-2" rows="2"
                        [(ngModel)]="newComment" placeholder="Votre commentaire..."></textarea>
              <button class="btn btn-sm btn-primary" (click)="addComment()">
                <i class="feather icon-send"></i> Envoyer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

@if (showToast()) {
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div class="toast show" role="alert" [ngClass]="'toast-' + toastType()">
      <div class="toast-body">{{ toastMessage() }}</div>
    </div>
  </div>
}
